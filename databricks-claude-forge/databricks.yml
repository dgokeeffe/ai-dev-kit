# ╔══════════════════════════════════════════════════════════════════════════╗
# ║  Databricks Asset Bundle - Git Integration Deployment                    ║
# ╚══════════════════════════════════════════════════════════════════════════╝
#
# This bundle provisions infrastructure AND deploys the app directly from
# the Git repository — no more manual file uploads or --prep-only steps.
#
# ╔══════════════════════════════════════════════════════════════════════════╗
# ║  Quick Start (Git-based)                                                 ║
# ╚══════════════════════════════════════════════════════════════════════════╝
#
# 1. Commit and push your changes:
#    git add . && git commit -m "Update app" && git push
#
# 2. Deploy infrastructure + create app with git repo link:
#    databricks bundle deploy -t dev
#
# 3. Deploy the app from Git:
#    ./scripts/deploy.sh --git <app-name>
#    # or manually:
#    databricks apps deploy <app-name> --json '{
#      "git_source": {
#        "branch": "main",
#        "source_code_path": "databricks-claude-forge"
#      }
#    }'
#
# 4. Grant Lakebase permissions:
#    ./scripts/grant_lakebase_permissions.sh <app-name>
#
# Note: The platform automatically runs `npm run build` during deployment,
# which builds the React frontend. No need to pre-build or commit client/out/.
#
# For detailed guide, see: docs/DEPLOYMENT.md
#
# ╔══════════════════════════════════════════════════════════════════════════╗
# ║  What This Bundle Provisions                                             ║
# ╚══════════════════════════════════════════════════════════════════════════╝
#
# - Lakebase PostgreSQL instance (CU_1 tier)
# - Databricks App with Git repository linked (source from GitHub)
# - Service principal with appropriate permissions
#
# ╔══════════════════════════════════════════════════════════════════════════╗
# ║  Working with Existing Lakebase Instances                                ║
# ╚══════════════════════════════════════════════════════════════════════════╝
#
# Use existing instance (prevents Terraform from recreating it):
#   databricks bundle deploy -t dev --var="lakebase_instance_name=your-instance"
#
# Deploy app only (don't touch DB) - use "existing" target:
#   # First time - bind existing instance:
#   databricks bundle deployment bind builder_db builder-app-db -t existing --auto-approve
#   databricks bundle deploy -t existing --var="lakebase_instance_name=builder-app-db"
#
#   # Later deploys (DB already bound):
#   databricks bundle deploy -t existing --var="lakebase_instance_name=builder-app-db"
#
# After any deploy, grant table permissions:
#   ./scripts/grant_lakebase_permissions.sh <app-name> <instance-name>

bundle:
  name: databricks-builder-app

# Sync section kept minimal — with git integration, app source code
# comes from the Git repo, not from local file uploads.
# Only needed if falling back to DABs file-based deployment.
sync:
  include:
    - "server/**"
    - "client/out/**"
    - "alembic/**"
    - "alembic.ini"
    - "requirements.txt"
    - "package.json"
    - "app.yaml"
  exclude:
    - "**/__pycache__"
    - "**/*.pyc"
    - "**/.env*"
    - "**/node_modules"
    - ".venv/**"
    - "**/tests/**"
    - "client/src/**"
    - "**/*.egg-info"

resources:
  # Lakebase database instance for persistence
  database_instances:
    builder_db:
      name: ${var.lakebase_instance_name}
      capacity: CU_1  # Smallest size - scale up as needed
      # Uncomment to stop instance when not in use (saves cost)
      # stopped: true

  # Database catalog not in bundle: Databricks provider returns "Update Database
  # Catalog is not yet implemented" on any catalog change. Create the UC catalog
  # for Lakebase manually once if needed (Lakebase UI or SQL).

  # Databricks App — with Git repository integration
  apps:
    builder_app:
      name: ${var.app_name}
      description: "Claude Code agent interface with integrated Databricks tools"
      # source_code_path is required by the bundle schema but is superseded
      # by git_repository when deploying via git_source.
      source_code_path: .
      # Git integration: app source is pulled from this repo on each deploy.
      # Deployments reference a branch/tag/commit + subdirectory via git_source.
      git_repository:
        provider: "gitHub"
        url: ${var.git_repo_url}
      # App resources
      resources:
        # Lakebase database for persistence
        - name: lakebase
          database:
            instance_name: ${resources.database_instances.builder_db.name}
            database_name: databricks_postgres
            permission: CAN_CONNECT_AND_CREATE
        # Foundation Model endpoints for Claude Code
        - name: claude-sonnet-45
          serving_endpoint:
            name: databricks-claude-sonnet-4-5
            permission: CAN_QUERY
        - name: claude-opus-46
          serving_endpoint:
            name: databricks-claude-opus-4-6
            permission: CAN_QUERY

variables:
  app_name:
    description: "Name of the Databricks App"
    default: "databricks-builder-app"
  personal_app_name:
    description: "Custom app name for personal deployments"
    default: "builder-app-dev"
  lakebase_instance_name:
    description: "Name of the Lakebase database instance"
    default: "builder-app-db"
  lakebase_catalog_name:
    description: "Name of the Unity Catalog catalog for Lakebase"
    default: "builder_app_catalog"
  git_repo_url:
    description: "Git repository URL for the app source code"
    default: "https://github.com/databricks-solutions/ai-dev-kit"
  git_branch:
    description: "Git branch to deploy from"
    default: "main"

targets:
  # Development target - provisions new Lakebase instance
  # Uses workspace from: databricks auth login or DATABRICKS_HOST env var
  dev:
    mode: development
    default: true

  # Use existing Lakebase instance – deploy app only, don't recreate/change DB.
  # First time: bind the DB, then deploy:
  #   databricks bundle deployment bind builder_db builder-app-db -t existing --auto-approve
  #   databricks bundle deploy -t existing -var="lakebase_instance_name=builder-app-db"
  existing:
    mode: development

  # Production target
  prod:
    mode: production
    variables:
      app_name: databricks-builder-app-prod
      lakebase_instance_name: builder-app-db-prod

  # Personal deployments with custom naming
  personal:
    mode: development
    variables:
      app_name: ${var.personal_app_name}
